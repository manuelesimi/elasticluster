#!/usr/bin/env python
# -*- coding: utf-8 -*-#
# @(#)ceph_facts
#
#
# Copyright (C) 2013, GC3, University of Zurich. All rights reserved.
#
#
# This program is free software; you can redistribute it and/or modify it
# under the terms of the GNU General Public License as published by the
# Free Software Foundation; either version 2 of the License, or (at your
# option) any later version.
#
# This program is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
# General Public License for more details.
#
# You should have received a copy of the GNU General Public License along
# with this program; if not, write to the Free Software Foundation, Inc.,
# 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA

__docformat__ = 'reStructuredText'


DOCUMENTATION = """
---
module: ceph_facts
short_description: Get facts about ceph
description:
    - This module will get facts related to ceph
author: Antonio Messina <antonio.s.messina@gmail.com>
options:
    none:
        description:
            - none
"""

import os
import socket
from subprocess import check_output

def main():
    module = AnsibleModule(argument_spec = dict())

    facts = {}
    hostname = socket.gethostname()
    sections = check_output(['ceph-conf', '--list-all-sections']).splitlines()
    for section in sections:
        try:
            host = check_output(['ceph-conf', '--name', section, 'host']).strip()
        except subprocess.CalledProcessError:
            continue
        if host == hostname:
            facts['ceph-name'] = section
            facts['ceph-idx'] = section.split('.')[-1]
            for cmd in ['mon data', 'mds data', 'osd data', 'devs', 'mon addr', 'mds addr', 'osd addr']:
                try:
                    facts[cmd] = check_output(['ceph-conf', '--name', section, cmd]).strip()
                except subprocess.CalledProcessError:
                    continue
            module.exit_json(ansible_facts=facts, changed=True)
    module.exit_json(changed=False)

# include magic from lib/ansible/module_common.py
#<<INCLUDE_ANSIBLE_MODULE_COMMON>>
main()
